// ─────────────────────────────────────────────────────────
//  Lucid AI — Prisma Schema
//  Stack: Next.js 14 · PostgreSQL · NextAuth v5
// ─────────────────────────────────────────────────────────

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════
//  ENUMS
// ═══════════════════════════════════════════════════════════

enum GitProvider {
  GITHUB
  GITLAB
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  FAILED
}

// ═══════════════════════════════════════════════════════════
//  USER — Supports OAuth (Google, GitHub, etc.)
// ═══════════════════════════════════════════════════════════

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // NextAuth relations
  accounts Account[]

  // User's resources
  integrations  Integration[]
  projects      Project[]
  agentSessions AgentSession[]

  @@map("users")
}

// ═══════════════════════════════════════════════════════════
//  ACCOUNT — NextAuth OAuth Accounts
// ═══════════════════════════════════════════════════════════

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// ═══════════════════════════════════════════════════════════
//  PROJECT — User's git repositories
// ═══════════════════════════════════════════════════════════

model Project {
  id        String       @id @default(cuid())
  name      String
  repoUrl   String?
  provider  GitProvider?
  branch    String       @default("main")
  isActive  Boolean      @default(true)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agentSessions AgentSession[]

  @@index([userId])
  @@map("projects")
}

// ═══════════════════════════════════════════════════════════
//  INTEGRATION — Encrypted Git Provider Tokens (per user)
// ═══════════════════════════════════════════════════════════

model Integration {
  id       String      @id @default(cuid())
  provider GitProvider
  label    String?

  // Encrypted access token (AES-256-CBC)
  accessTokenEncrypted String  @db.Text
  iv                   String

  // Optional metadata
  externalUsername String?
  scopes           String?
  expiresAt        DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, provider])
  @@map("integrations")
}

// ═══════════════════════════════════════════════════════════
//  AGENT SESSION — Active AI Agent Sessions
// ═══════════════════════════════════════════════════════════

model AgentSession {
  id             String        @id @default(cuid())
  title          String?
  status         SessionStatus @default(ACTIVE)
  agentSessionId String?       @unique

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  metadata    Json?
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([userId])
  @@index([status])
  @@map("agent_sessions")
}
